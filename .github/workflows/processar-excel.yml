name: Processar Upload via Issue

on:
  issues:
    types: [opened]

jobs:
  processar:
    # S√≥ executa se a issue tiver a label 'auto-process'
    if: contains(github.event.issue.labels.*.name, 'auto-process')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Extrair URL do arquivo
        id: extract
        run: |
          # Extrai a URL do corpo da issue
          URL=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=**URL:** ).*')
          echo "file_url=$URL" >> $GITHUB_OUTPUT
          echo "üìé URL extra√≠da: $URL"
      
      - name: Baixar arquivo
        run: |
          curl -L "${{ steps.extract.outputs.file_url }}" -o Emitir.xlsx
          echo "‚úÖ Arquivo baixado: $(ls -lh Emitir.xlsx)"
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Instalar depend√™ncias
        run: |
          pip install pandas openpyxl psycopg2-binary tqdm
      
      - name: Processar e enviar para Neon
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TABELA: ${{ secrets.TABELA }}
        run: |
          python scripts/upload_planilha_neon.py
      
      - name: Comentar sucesso na issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ **Processamento conclu√≠do com sucesso!**\n\nOs dados foram importados para o Neon PostgreSQL.'
            });
      
      - name: Comentar erro na issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ùå **Erro no processamento**\n\nVerifique os logs do workflow para mais detalhes.'
            });
      
      - name: Fechar issue automaticamente
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.event.issue.number }}
          path: '*.log'
          retention-days: 7